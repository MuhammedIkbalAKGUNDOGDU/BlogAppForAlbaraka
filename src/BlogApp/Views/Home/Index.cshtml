@{
    ViewData["Title"] = "Ana Sayfa";
}

<div class="container mt-4">
    <h1 class="mb-4">Blog Yazıları</h1>

    <!-- Arama ve Filtreleme -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="searchInput" class="form-label">
                        <i class="bi bi-search"></i> Arama
                    </label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Başlık, içerik veya yazar adında ara..." />
                </div>
                <div class="col-md-3">
                    <label for="categoryFilter" class="form-label">
                        <i class="bi bi-funnel"></i> Kategori Filtresi
                    </label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">Tüm Kategoriler</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sortBy" class="form-label">
                        <i class="bi bi-sort-down"></i> Sıralama
                    </label>
                    <select class="form-select" id="sortBy">
                        <option value="date">Tarihe Göre (Yeni → Eski)</option>
                        <option value="popularity">Popülerlik</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" id="clearFilters" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="postsContainer">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    </div>
</div>

<script>
let searchTimeout = null;
let currentSearch = '';
let currentCategoryId = '';
let currentSortBy = 'date';

document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadPosts();

    // Arama input'u için debounce (500ms bekle)
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = this.value.trim();
            loadPosts();
        }, 500);
    });

    // Kategori filtresi değiştiğinde
    document.getElementById('categoryFilter').addEventListener('change', function() {
        currentCategoryId = this.value;
        loadPosts();
    });

    // Sıralama değiştiğinde
    document.getElementById('sortBy').addEventListener('change', function() {
        currentSortBy = this.value;
        loadPosts();
    });
});

async function loadCategories() {
    try {
        const res = await fetch('/api/category');
        if (res.ok) {
            const categories = await res.json();
            const select = document.getElementById('categoryFilter');
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Kategoriler yüklenemedi:', error);
    }
}

async function loadPosts() {
    const container = document.getElementById('postsContainer');
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
        </div>
    `;

    try {
        let url = '/api/blogpost/published?';
        if (currentSearch) {
            url += `search=${encodeURIComponent(currentSearch)}&`;
        }
        if (currentCategoryId) {
            url += `categoryId=${currentCategoryId}&`;
        }
        url += `sortBy=${currentSortBy}`;

        const res = await fetch(url);
        if (res.ok) {
            const posts = await res.json();
            
            if (posts.length === 0) {
                let message = 'Henüz yayınlanmış yazı bulunmamaktadır.';
                if (currentSearch || currentCategoryId) {
                    message = 'Arama kriterlerinize uygun yazı bulunamadı.';
                }
                container.innerHTML = `<div class="alert alert-info">${message}</div>`;
                return;
            }

            container.innerHTML = posts.map(post => {
                // Arama terimini vurgula (highlight)
                let title = escapeHtml(post.title);
                let content = escapeHtml(post.content.substring(0, 200));
                let authorName = escapeHtml(`${post.user.firstName} ${post.user.lastName}`);
                
                if (currentSearch) {
                    const searchRegex = new RegExp(`(${escapeRegex(currentSearch)})`, 'gi');
                    title = title.replace(searchRegex, '<mark>$1</mark>');
                    content = content.replace(searchRegex, '<mark>$1</mark>');
                    authorName = authorName.replace(searchRegex, '<mark>$1</mark>');
                }

                return `
                    <div class="card mb-4 shadow-sm" style="cursor: pointer;" onclick="window.location.href='/BlogPost/Details?id=${post.id}'">
                        ${post.coverImage ? `<img src="${post.coverImage}" class="card-img-top" alt="${post.title}" style="max-height: 300px; object-fit: cover;">` : ''}
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">${title}</h5>
                                <span class="badge bg-secondary">${post.category.name}</span>
                            </div>
                            <p class="card-text">${content}${post.content.length > 200 ? '...' : ''}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        <i class="bi bi-person"></i> ${authorName} | 
                                        <i class="bi bi-calendar"></i> ${new Date(post.createdAt).toLocaleDateString('tr-TR')} | 
                                        <i class="bi bi-eye"></i> ${post.viewCount} görüntüleme
                                    </small>
                                </div>
                                <div>
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-chat"></i> ${post.commentCount} Yorum
                                    </span>
                                    <span class="badge bg-danger">
                                        <i class="bi bi-heart"></i> ${post.likeCount} Beğeni
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = '<div class="alert alert-danger">Yazılar yüklenemedi.</div>';
        }
    } catch (error) {
        console.error('Hata:', error);
        container.innerHTML = '<div class="alert alert-danger">Bir hata oluştu.</div>';
    }
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('sortBy').value = 'date';
    currentSearch = '';
    currentCategoryId = '';
    currentSortBy = 'date';
    loadPosts();
}

// XSS koruması için HTML escape
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Regex özel karakterlerini escape et
function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>

<style>
mark {
    background-color: #ffc107;
    padding: 2px 4px;
    border-radius: 3px;
}
</style>
